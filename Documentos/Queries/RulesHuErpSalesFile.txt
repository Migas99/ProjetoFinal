----------------------------------------------------------------------------------------------------------------
Rule ID: 20_GTMS_086
Rule Description: Validate if the records from ERP have a supplier name (Sales Invoice)

Rule Query:
SELECT
	si.import_id,
	si.row_key AS uid, 
	si.merge_key AS uid2,
	si.invoice_number,
	si.supplier_name
	FROM #EM{HuErpSalesInvoice} as si
	WHERE si.supplier_name is null OR si.supplier_name = '' 
	and si.import_id = #{colbi.import_id} 
	AND si.final_version = 1
  (O #EM{HuErpSalesInvoice} e o #{colbi.import_id} são placeholders que são substituidos on the fly com base no nome da tabela (ex: hu_erp_[FISCAL_YEAR]_[PROJECT_ID]_sales_invoices e o [FISCAL_YEAR] e o [PROJECT_ID] são substituidos pelos que etão em uso no sistema e o #{colbi.import_id} respetivamente))

Rule Success Message: All records have a Supplier name
Rule Insuccess Message: The invoice @invoice_number doesn't have any supplier name associated (o @invoice_number é um placeholder que é susbituido se a query tiver algum resultado)
----------------------------------------------------------------------------------------------------------------
Rule ID: 20_GTMS_081
Rule Description: Check if line net amount multiplied by line vat percentage equals to line vat amount (Sales Invoice Line)

Rule Query:
SELECT 
	sil.import_id,
	sil.row_key AS uid,
	sil.merge_key AS uid2,
	sil.invoice_number, 
	sil.line_number,
	sil.line_net_amount,
	sil.line_tax_percentage,
	sil.line_tax_amount,
	sil.currency_code,
	round(round(sil.line_net_amount * sil.line_tax_percentage ,2)/100,2) - sil.line_tax_amount as dif
	FROM #EM{HuErpSalesInvoice} si
	INNER JOIN #EM{HuErpSalesInvoiceLine} sil 
	ON si.row_key = sil.hu_erp_sales_invoice_id
	WHERE (abs(ROUND(sil.line_net_amount * (sil.line_tax_percentage/100),2) - ROUND(sil.line_tax_amount,2)) > 0.01
	AND sil.currency_code = \"HUF\"
	AND sil.import_id = #{colbi.import_id}
	AND sil.final_version = 1
	AND si.import_id = #{colbi.import_id}
	AND si.final_version = 1)
	OR (abs(ROUND(sil.line_net_amount * (sil.line_tax_percentage/100),2) - ROUND(sil.line_tax_amount,2)) > 1
	AND sil.currency_code = \"HUF\"
	AND sil.import_id = #{colbi.import_id}
	AND sil.final_version = 1
	AND si.import_id = #{colbi.import_id}
	AND si.final_version = 1)

Rule Success Message: No errors found
Rule Insuccess Message: Line net amount multiplied by line vat percentage does not match with line vat amount with a diference of @dif for the invoice number @invoice_number on the line @line_number
----------------------------------------------------------------------------------------------------------------
Rule ID: 20_GTMS_094
Rule Description: Checks if county code from customer is valid (Sales Invoice)

Rule Query: 
SELECT
    import_id,
    row_key AS uid,
    merge_key AS uid2,
    invoice_number,
    customer_county_code,
    customer_id,
    customer_name
    FROM #EM{HuErpSalesInvoice}
    where 
    final_version = 1 
    and import_id = #{colbi.import_id}
    and customer_county_code is not null
    and ((customer_county_code < 2)
    or (customer_county_code > 20 and customer_county_code < 22)
    or (customer_county_code > 44 and customer_county_code < 51)
    or (customer_county_code > 51))

Rule Success Message: Customer county code is valid
Rule Insuccess Message: The county code @customer_county_code for the customer @customer_name with the customer id @customer_id on the invoice @invoice_number is invalid (must be 02–20, 22–44, 51).
----------------------------------------------------------------------------------------------------------------
Rule ID: 20_GTMS_097
Rule Description: Check if unit price multiplied by quantity minus discount value plus tax amount equals to gross amount (Sales Invoice Line)

Rule Query:
SELECT 
    sil.import_id,
    sil.row_key AS uid,
    sil.merge_key AS uid2,
    sil.invoice_number, 
    sil.line_number,
    sil.gross_amount,
    round(round(sil.unit_price * sil.quantity - sil.discount_value + sil.line_tax_amount,2),2) - ROUND(sil.gross_amount,2) as dif
    FROM  #EM{HuErpSalesInvoice} si
    INNER JOIN #EM{HuErpSalesInvoiceLine} sil 
    ON si.row_key = sil.hu_erp_sales_invoice_id
    WHERE (abs(ROUND(sil.unit_price * sil.quantity - sil.discount_value + sil.line_tax_amount,2) - ROUND(sil.gross_amount, 2)) > 0.01
    AND sil.currency_code = "HUF"
    AND sil.import_id = #{colbi.import_id} 
    AND sil.final_version = 1
    AND si.import_id = #{colbi.import_id}
    AND si.final_version = 1)
    OR (abs(ROUND(sil.unit_price * sil.quantity - sil.discount_value + sil.line_tax_amount,2) - ROUND(sil.gross_amount, 2)) > 1
    AND sil.currency_code = "HUF"
    AND sil.import_id = #{colbi.import_id}
    AND sil.final_version = 1
    AND si.import_id = #{colbi.import_id}
    AND si.final_version = 1)

Rule Success Message: No Errors Found
Rule Insuccess Message: Unit price multiplied by quantity minus discount value plus tax amount does not match with gross amount with a diference of @dif for the invoice number @invoice_number on the line @line_number